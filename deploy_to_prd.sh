#!/bin/zsh

# Проверка на наличие несохранённых изменений
if ! git diff-index --quiet HEAD --; then
    echo "Есть несохранённые изменения. Сохраните их перед переносом."
    exit 1
fi

# Переключение на ветку dev
echo "Переключаюсь на ветку dev..."
git checkout dev

# Получение последних изменений из удалённого репозитория
echo "Получаю последние изменения из удалённого репозитория dev..."
git pull origin dev

# Переключение на ветку prd
echo "Переключаюсь на ветку prd..."
git checkout prd

# Получение последних изменений для prd
echo "Получаю последние изменения для prd..."
git pull origin prd

# Слияние изменений из dev в prd
echo "Сливаю изменения из dev в prd..."
git merge dev

# Проверка успешности слияния
if [ $? -ne 0 ]; then
    echo "Ошибка при слиянии веток. Проверьте конфликты."
    exit 1
fi

# Установка тэга с текущей датой и временем
TAG_NAME="release-$(date +'%Y%m%d-%H%M%S')"
echo "Создаю тэг: $TAG_NAME..."
git tag -a "$TAG_NAME" -m "Релиз от $(date +'%Y-%m-%d %H:%M:%S')"

# Отправка изменений и тэга в удалённый репозиторий
echo "Отправляю изменения в удалённый репозиторий..."
git push origin prd
git push origin "$TAG_NAME"

echo "Ревизия из dev перенесена в prd с тэгом $TAG_NAME."
